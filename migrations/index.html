
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Simple SQL database layer">
      
      
      
        <link rel="canonical" href="https://git.oddbit.org/OddBit/rick_db/migrations/">
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.4.3, mkdocs-material-8.1.2">
    
    
      
        <title>Migrations - RickDb</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.f7951f6f.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.e6a45f82.min.css">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#migrations" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="RickDb" class="md-header__button md-logo" aria-label="RickDb" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            RickDb
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Migrations
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://git.oddbit.org/OddBit/rick_db" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    OddBit/rick_db
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="RickDb" class="md-nav__button md-logo" aria-label="RickDb" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    RickDb
  </label>
  
    <div class="md-nav__source">
      <a href="https://git.oddbit.org/OddBit/rick_db" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    OddBit/rick_db
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Overview
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../install/" class="md-nav__link">
        Installation
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../connection/" class="md-nav__link">
        Connection
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../object_mapper/" class="md-nav__link">
        Object Mapper
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../building_queries/" class="md-nav__link">
        Query Builder
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../repository/" class="md-nav__link">
        Repositories
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../grid/" class="md-nav__link">
        DbGrid
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Migrations
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Migrations
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#why-forward-only" class="md-nav__link">
    Why forward-only?
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#configuration" class="md-nav__link">
    Configuration
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#installation" class="md-nav__link">
    Installation
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#creating-migrations" class="md-nav__link">
    Creating migrations
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#applying-migrations" class="md-nav__link">
    Applying migrations
  </a>
  
    <nav class="md-nav" aria-label="Applying migrations">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#rickdb-check-path" class="md-nav__link">
    rickdb check &lt;path&gt;
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rickdb-migrate-path" class="md-nav__link">
    rickdb migrate &lt;path&gt;
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#flattening-migrations" class="md-nav__link">
    Flattening migrations
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#generating-dtos" class="md-nav__link">
    Generating DTOs
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_9" type="checkbox" id="__nav_9" >
      
      
      
      
        <label class="md-nav__link" for="__nav_9">
          Class List
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Class List" data-md-level="1">
        <label class="md-nav__title" for="__nav_9">
          <span class="md-nav__icon md-icon"></span>
          Class List
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../classes/record/" class="md-nav__link">
        Record
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../classes/connection/" class="md-nav__link">
        Connection
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../classes/cursor/" class="md-nav__link">
        Cursor
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../classes/profiler/" class="md-nav__link">
        Profiler
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../classes/repository/" class="md-nav__link">
        Repository
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../classes/sqldialect/" class="md-nav__link">
        SqlDialect
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../classes/select/" class="md-nav__link">
        Select
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../classes/insert/" class="md-nav__link">
        Insert
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../classes/update/" class="md-nav__link">
        Update
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../classes/delete/" class="md-nav__link">
        Delete
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../classes/literal/" class="md-nav__link">
        Literal
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../classes/with/" class="md-nav__link">
        CTEs (With)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../classes/dbgrid/" class="md-nav__link">
        DbGrid
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#why-forward-only" class="md-nav__link">
    Why forward-only?
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#configuration" class="md-nav__link">
    Configuration
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#installation" class="md-nav__link">
    Installation
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#creating-migrations" class="md-nav__link">
    Creating migrations
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#applying-migrations" class="md-nav__link">
    Applying migrations
  </a>
  
    <nav class="md-nav" aria-label="Applying migrations">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#rickdb-check-path" class="md-nav__link">
    rickdb check &lt;path&gt;
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rickdb-migrate-path" class="md-nav__link">
    rickdb migrate &lt;path&gt;
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#flattening-migrations" class="md-nav__link">
    Flattening migrations
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#generating-dtos" class="md-nav__link">
    Generating DTOs
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                

<h1 id="migrations">Migrations</h1>
<p>RickDb is a schema-first library - there is no automatic generation of database objects; instead they are
usually modeled using raw SQL, and kept in files separated from application code.</p>
<p>While there are plenty of tools to manage migration, RickDb provides a simple, forward-only migration manager
cli utility that can be used to manage these SQL files, <strong>rickdb</strong>.</p>
<h2 id="why-forward-only">Why forward-only?</h2>
<p>Many database migration tools provide mechanisms to create and remove database objects, with the purpose of 
rolling back schema changes. However, rolling back schema changes can lead to the truncation of relevant data;
adding a field, then removing it will effectively truncate the stored information; however, adding a row with an 
automatic identity field, then removing it will not rollback the underlying identity sequence value. While this
kind of rollback capability is quite popular, it is obvious most SGBDs can't actually perform rollbacks the way
they were conceptualized.</p>
<p>Instead of this approach, RickDb's Migration Manager only supports "forward-only" migrations - a sequence of SQL
files with the desired changes for a given database. These changes can be additive (e.g. creating tables and 
views), transformational (e.g. adding fields or indexes) or destructive (e.g. removing tables, views, fields, etc).</p>
<h2 id="configuration">Configuration</h2>
<p>The bundled Migration Manager requires a TOML configuration file, called by default <strong>rickdb.toml</strong>, containing 
the database connection details. The file usually resides in the project root directory, but can also have a
custom location, specified by the environment variable <strong>RICKDB_CONFIG</strong>.</p>
<p>The TOML config file can have one or more database configuration keys. These keys may be a single
default key <strong>db</strong> (for single database applications), or multiple, name-based keys prefixed with <strong>db_</strong>:</p>
<p>Simple single-database configuration example:</p>
<p><div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="c1"># single database, no name</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="k">[db]</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="n">engine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;pgsql&quot;</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="n">host</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;localhost&quot;</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="n">port</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5432</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="n">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;myuser&quot;</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="n">password</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;mypassword&quot;</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="n">dbname</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;myschema&quot;</span>
</code></pre></div>
Multiple database configuration example:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="c1"># administration database</span>
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="k">[db_admin]</span>
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="n">engine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;pgsql&quot;</span>
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a><span class="n">host</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;localhost&quot;</span>
<a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a><span class="n">port</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5432</span>
<a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a><span class="n">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;myuser&quot;</span>
<a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a><span class="n">password</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;mypassword&quot;</span>
<a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a><span class="n">dbname</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;admin_schema&quot;</span>
<a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a>
<a id="__codelineno-1-10" name="__codelineno-1-10" href="#__codelineno-1-10"></a><span class="c1"># application database</span>
<a id="__codelineno-1-11" name="__codelineno-1-11" href="#__codelineno-1-11"></a><span class="k">[db_app]</span>
<a id="__codelineno-1-12" name="__codelineno-1-12" href="#__codelineno-1-12"></a><span class="n">engine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;pgsql&quot;</span>
<a id="__codelineno-1-13" name="__codelineno-1-13" href="#__codelineno-1-13"></a><span class="n">host</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;localhost&quot;</span>
<a id="__codelineno-1-14" name="__codelineno-1-14" href="#__codelineno-1-14"></a><span class="n">port</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5432</span>
<a id="__codelineno-1-15" name="__codelineno-1-15" href="#__codelineno-1-15"></a><span class="n">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;myuser&quot;</span>
<a id="__codelineno-1-16" name="__codelineno-1-16" href="#__codelineno-1-16"></a><span class="n">dbname</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;app_schema&quot;</span>
<a id="__codelineno-1-17" name="__codelineno-1-17" href="#__codelineno-1-17"></a><span class="n">passfile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;/var/run/super_secret_pwd&quot;</span>
<a id="__codelineno-1-18" name="__codelineno-1-18" href="#__codelineno-1-18"></a>
<a id="__codelineno-1-19" name="__codelineno-1-19" href="#__codelineno-1-19"></a><span class="c1"># test database</span>
<a id="__codelineno-1-20" name="__codelineno-1-20" href="#__codelineno-1-20"></a><span class="k">[db_test]</span>
<a id="__codelineno-1-21" name="__codelineno-1-21" href="#__codelineno-1-21"></a><span class="n">engine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;sqlite&quot;</span>
<a id="__codelineno-1-22" name="__codelineno-1-22" href="#__codelineno-1-22"></a><span class="n">db_file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;/tmp/test.db&quot;</span><span class="w">    </span>
</code></pre></div>
<p>If a <strong>[db]</strong> section exists, it will be used when no database is specified in the cli arguments; db_&lt;name&gt; configurations
can be invoked by providing &lt;name&gt; as the first argument:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="c1"># use [db] database</span>
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a>$<span class="w"> </span>rickdb<span class="w"> </span>list<span class="w"> </span>
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="m">14</span>/12/2021<span class="w"> </span><span class="m">18</span>:28:56<span class="w">     </span><span class="m">001</span>.sql
<a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="m">15</span>/12/2021<span class="w"> </span><span class="m">19</span>:32:58<span class="w">     </span><span class="m">002</span>.sql
<a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a><span class="m">15</span>/12/2021<span class="w"> </span><span class="m">19</span>:33:42<span class="w">     </span><span class="m">003</span>.sql
<a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a>
<a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a><span class="c1"># use [db_app] database</span>
<a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a>$<span class="w"> </span>rickdb<span class="w"> </span>app<span class="w"> </span>list
<a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a><span class="m">15</span>/12/2021<span class="w"> </span><span class="m">19</span>:15:00<span class="w">     </span>001_schema.sql
</code></pre></div>
<p>In addition to the parameters required by the connection object, there are two additional parameters:</p>
<table>
<thead>
<tr>
<th>Parameter</th>
<th>Mandatory</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>engine</td>
<td>yes</td>
<td>Database engine to use (currently "pgsql" or "sqlite")</td>
</tr>
<tr>
<td>passfile</td>
<td>no</td>
<td>Optional password file containing the database password</td>
</tr>
</tbody>
</table>
<p>Engine is a mandatory field that specifies which database Connection object will be used. Currently, its value can
be either 'pgsql' or 'sqlite'.</p>
<p>Passfile is an optional parameter indicating that the password should be read from an existing file
instead. When <strong>passfile</strong> is used, the file is read into a <strong>password</strong> parameter automatically. Keep in
mind, if both <strong>password</strong> and <strong>passfile</strong> are used, <strong>passfile</strong> overrides the password contents.</p>
<h2 id="installation">Installation</h2>
<p>The Migration Manager requires a database table to record executed migration information. This database table
can be easily created via command-line:</p>
<p>Single database configuration:
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a>$<span class="w"> </span>rickdb<span class="w"> </span>init
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a>Migration<span class="w"> </span>Manager<span class="w"> </span>installed<span class="w"> </span>sucessfully!
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a>$
</code></pre></div></p>
<p>Multiple database configuration, in this case for db_app:
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a>$<span class="w"> </span>rickdb<span class="w"> </span>app<span class="w"> </span>init
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a>Migration<span class="w"> </span>Manager<span class="w"> </span>installed<span class="w"> </span>sucessfully!
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a>$
</code></pre></div></p>
<h2 id="creating-migrations">Creating migrations</h2>
<p>To create a migration, just create a directory with a set of SQL files. It is good practice to name the files sequentially,
as migrations are executed ordered by name. The naming format is free-form, as long as the file has an <strong>.sql</strong> extension
in lowercase.</p>
<p>Common migration naming examples:
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="c1"># sequence number</span>
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="m">0001</span>.sql
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a><span class="m">0002</span>.sql
<a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a>
<a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a><span class="c1"># sequence number &amp; description</span>
<a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a><span class="m">0001</span>-base_schema.sql
<a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a><span class="m">0002</span>-index_change_users.sql
<a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a>
<a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a><span class="c1"># ticket name &amp; description</span>
<a id="__codelineno-5-10" name="__codelineno-5-10" href="#__codelineno-5-10"></a>TICKET001-some_stuff.sql
<a id="__codelineno-5-11" name="__codelineno-5-11" href="#__codelineno-5-11"></a>TICKET002-other_stuff.sql
<a id="__codelineno-5-12" name="__codelineno-5-12" href="#__codelineno-5-12"></a>
<a id="__codelineno-5-13" name="__codelineno-5-13" href="#__codelineno-5-13"></a><span class="c1"># date</span>
<a id="__codelineno-5-14" name="__codelineno-5-14" href="#__codelineno-5-14"></a><span class="m">20210101</span>-something.sql
<a id="__codelineno-5-15" name="__codelineno-5-15" href="#__codelineno-5-15"></a><span class="m">20210102</span>-something_else.sql
</code></pre></div>
Keep in mind, each migration file should be treated as immutable - each file is only applied/executed once. Subsequent
changes to the file will be ignored; any desired changes to the file after it has been run should be made on a separate 
migration. </p>
<h2 id="applying-migrations">Applying migrations</h2>
<p>The migration manager provides two useful commands to manage pending migrations - check and migrate.</p>
<h4 id="rickdb-check-path">rickdb check &lt;path&gt;</h4>
<p>This command compares all migration names in the specified path with the already applied ones, indicating which ones were
already applied:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a>$<span class="w"> </span>rickdb<span class="w"> </span>check<span class="w"> </span>migrations/
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a>Checking<span class="w"> </span><span class="m">001</span>.sql...<span class="w"> </span>already<span class="w"> </span>applied
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a>Checking<span class="w"> </span><span class="m">002</span>.sql...<span class="w"> </span>already<span class="w"> </span>applied
<a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a>Checking<span class="w"> </span><span class="m">003</span>.sql...<span class="w"> </span>new<span class="w"> </span>migration
<a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a>$
</code></pre></div>
<h4 id="rickdb-migrate-path">rickdb migrate &lt;path&gt;</h4>
<p>This command executes the new migrations, one by one, from the specified directory, ordered by file name. If any error occurs,
execution is aborted. The migrations are not executed within a transaction, due to varying transaction support in 
database engines; any required transaction blocks must be explicit, or there is always the possibility of failure in the
middle of a multi-statement migration. Partially failed migrations are not registered (because execution is aborted), and
should be handled manually.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a>$<span class="w"> </span>rickdb<span class="w"> </span>migrate<span class="w"> </span>migrations/
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a>Executing<span class="w"> </span><span class="m">001</span>.sql...<span class="w"> </span>skipping,<span class="w"> </span>already<span class="w"> </span>applied
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a>Executing<span class="w"> </span><span class="m">002</span>.sql...<span class="w"> </span>skipping,<span class="w"> </span>already<span class="w"> </span>applied
<a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a>Executing<span class="w"> </span><span class="m">003</span>.sql...<span class="w"> </span>success
<a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a>$
</code></pre></div>
<h2 id="flattening-migrations">Flattening migrations</h2>
<p>During a schema-first application lifecycle, it is common to periodically combine all the migrations in a single sql
file, or to replace them with a clean schema dump instead. This way, the number of migration files is kept to a sane level
while assuming a certain schema state (either from a backup or from a plain file).</p>
<p>When this is done, it is necessary to "notify" the migration manager that all the applied migrations ceased to exist, and
now reside on a specific file <strong>to be ignored</strong> (except on clean deploys), as migrations have already been applied.</p>
<p>To remove all those applied migration names and replace them with a single entry with a custom name, we use the 
<strong>flatten</strong> command:
<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a>$<span class="w"> </span>rickdb<span class="w"> </span>flatten<span class="w"> </span>schema.sql
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a>Flattening<span class="w"> </span>all<span class="w"> </span>migrations<span class="w"> </span>to<span class="w"> </span>schema.sql...<span class="w"> </span>success
</code></pre></div>
In the above example, the migration manager will remove all information of applied migrations, and create a single entry
with schema.sql as migration name.</p>
<h2 id="generating-dtos">Generating DTOs</h2>
<p>In addition to the Migration Manager functionalities, rickdb cli also provides basic code-generation capabilities based
on the object mapper - specifically, the capability of generating field mapper class definitions from database objects - 
tables and views:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="err">$</span> <span class="n">rickdb</span> <span class="n">dto</span> <span class="n">page</span> <span class="n">page</span><span class="o">.</span><span class="n">py</span>
<a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a><span class="n">DAO</span> <span class="n">written</span> <span class="n">to</span> <span class="n">file</span> <span class="n">page</span><span class="o">.</span><span class="n">py</span>
<a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a><span class="err">$</span> <span class="n">cat</span> <span class="n">page</span><span class="o">.</span><span class="n">py</span> 
<a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a><span class="kn">from</span> <span class="nn">rick_db</span> <span class="kn">import</span> <span class="n">fieldmapper</span>
<a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a>
<a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a>
<a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a><span class="nd">@fieldmapper</span><span class="p">(</span><span class="n">tablename</span><span class="o">=</span><span class="s1">&#39;page&#39;</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="s1">&#39;id_page&#39;</span><span class="p">)</span>
<a id="__codelineno-9-8" name="__codelineno-9-8" href="#__codelineno-9-8"></a><span class="k">class</span> <span class="nc">Page</span><span class="p">:</span>
<a id="__codelineno-9-9" name="__codelineno-9-9" href="#__codelineno-9-9"></a>    <span class="nb">id</span> <span class="o">=</span> <span class="s1">&#39;id_page&#39;</span>
<a id="__codelineno-9-10" name="__codelineno-9-10" href="#__codelineno-9-10"></a>    <span class="n">crawled</span> <span class="o">=</span> <span class="s1">&#39;crawled&#39;</span>
<a id="__codelineno-9-11" name="__codelineno-9-11" href="#__codelineno-9-11"></a>    <span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;url&#39;</span>
<a id="__codelineno-9-12" name="__codelineno-9-12" href="#__codelineno-9-12"></a>    <span class="nb">type</span> <span class="o">=</span> <span class="s1">&#39;type&#39;</span>
<a id="__codelineno-9-13" name="__codelineno-9-13" href="#__codelineno-9-13"></a>    <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;title&#39;</span>
<a id="__codelineno-9-14" name="__codelineno-9-14" href="#__codelineno-9-14"></a>    <span class="n">description</span> <span class="o">=</span> <span class="s1">&#39;description&#39;</span>
<a id="__codelineno-9-15" name="__codelineno-9-15" href="#__codelineno-9-15"></a>    <span class="n">breadcrumbs</span> <span class="o">=</span> <span class="s1">&#39;breadcrumbs&#39;</span>
</code></pre></div>
<p>And, of course, PostgreSQL schemas are supported out-of-the-box, too:
<div class="highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="err">$</span> <span class="n">rickdb</span> <span class="n">dto</span> <span class="n">test</span><span class="o">.</span><span class="n">some_page</span> <span class="n">page</span><span class="o">.</span><span class="n">py</span>
<a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a><span class="n">DAO</span> <span class="n">written</span> <span class="n">to</span> <span class="n">file</span> <span class="n">page</span><span class="o">.</span><span class="n">py</span>
<a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a><span class="err">$</span> <span class="n">cat</span> <span class="n">page</span><span class="o">.</span><span class="n">py</span> 
<a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a><span class="kn">from</span> <span class="nn">rick_db</span> <span class="kn">import</span> <span class="n">fieldmapper</span>
<a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a>
<a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a>
<a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a><span class="nd">@fieldmapper</span><span class="p">(</span><span class="n">tablename</span><span class="o">=</span><span class="s1">&#39;some_page&#39;</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="s1">&#39;test&#39;</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="s1">&#39;id_page&#39;</span><span class="p">)</span>
<a id="__codelineno-10-8" name="__codelineno-10-8" href="#__codelineno-10-8"></a><span class="k">class</span> <span class="nc">SomePage</span><span class="p">:</span>
<a id="__codelineno-10-9" name="__codelineno-10-9" href="#__codelineno-10-9"></a>    <span class="nb">id</span> <span class="o">=</span> <span class="s1">&#39;id_page&#39;</span>
<a id="__codelineno-10-10" name="__codelineno-10-10" href="#__codelineno-10-10"></a>    <span class="n">crawled</span> <span class="o">=</span> <span class="s1">&#39;crawled&#39;</span>
<a id="__codelineno-10-11" name="__codelineno-10-11" href="#__codelineno-10-11"></a>    <span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;url&#39;</span>
<a id="__codelineno-10-12" name="__codelineno-10-12" href="#__codelineno-10-12"></a>    <span class="nb">type</span> <span class="o">=</span> <span class="s1">&#39;type&#39;</span>
<a id="__codelineno-10-13" name="__codelineno-10-13" href="#__codelineno-10-13"></a>    <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;title&#39;</span>
<a id="__codelineno-10-14" name="__codelineno-10-14" href="#__codelineno-10-14"></a>    <span class="n">description</span> <span class="o">=</span> <span class="s1">&#39;description&#39;</span>
<a id="__codelineno-10-15" name="__codelineno-10-15" href="#__codelineno-10-15"></a>    <span class="n">breadcrumbs</span> <span class="o">=</span> <span class="s1">&#39;breadcrumbs&#39;</span>
</code></pre></div></p>

              
            </article>
          </div>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        
        <a href="../grid/" class="md-footer__link md-footer__link--prev" aria-label="Previous: DbGrid" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              DbGrid
            </div>
          </div>
        </a>
      
      
        
        <a href="../classes/record/" class="md-footer__link md-footer__link--next" aria-label="Next: Record" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Record
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.0bbba5b5.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.649a939e.min.js"></script>
      
    
  </body>
</html>